# Reusable workflow to check self-hosted runner availability.
# Falls back to ubuntu-latest if the runner is offline, not found,
# or if RUNNER_TOKEN is not configured (e.g., in forks).

name: Check Runner

on:
  workflow_call:
    outputs:
      runner:
        description: 'JSON label array for runs-on (e.g., ["self-hosted","Windows","X64"] or ["ubuntu-latest"])'
        value: ${{ jobs.check-runner.outputs.runner }}

jobs:
  check-runner:
    name: Check Runner
    runs-on: ubuntu-latest
    outputs:
      runner: ${{ steps.check.outputs.runner }}
    steps:
      - name: Check self-hosted runner availability
        id: check
        # RUNNER_TOKEN requires a fine-grained PAT with Administration:read
        # scoped to this repository. Falls back gracefully if not set.
        env:
          GH_TOKEN: ${{ secrets.RUNNER_TOKEN }}
        run: |
          RUNNER='["ubuntu-latest"]'
          if STATUS=$(gh api "repos/${{ github.repository }}/actions/runners" \
            --jq '.runners[] | select(.name == "armor-hider-runner") | .status' 2>&1); then
            if [ "$STATUS" = "online" ]; then
              RUNNER='["self-hosted","Windows","X64"]'
            elif [ -z "$STATUS" ]; then
              echo "::warning::Self-hosted runner 'armor-hider-runner' not found. Falling back to ubuntu-latest."
            else
              echo "::warning::Self-hosted runner 'armor-hider-runner' has status '$STATUS'. Falling back to ubuntu-latest."
            fi
          else
            echo "::warning::Failed to query runner status via gh api. Falling back to ubuntu-latest."
          fi
          echo "Using runner: $RUNNER"
          echo "runner=$RUNNER" >> $GITHUB_OUTPUT
