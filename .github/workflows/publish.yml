name: Build & Publish

on:
  release:
    types: [published]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force create a prerelease even if only non-code files changed'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Run full pipeline without actually publishing (overrides PUBLISH_TO_MODRINTH and skips GitHub release creation)'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  MODRINTH_PROJECT_ID: 'zannaghs-armor-hider'
  # Set to 'true' to enable actual Modrinth publishing, 'false' for dry-run
  PUBLISH_TO_MODRINTH: 'true'

jobs:
  analyze:
    name: Analyze Changes
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.release-check.outputs.should_release }}
      is_manual_release: ${{ steps.release-check.outputs.is_manual_release }}
      skip_reason: ${{ steps.release-check.outputs.skip_reason }}
      semver: ${{ steps.version.outputs.majorMinorPatch }}
      prerelease_number: ${{ steps.version.outputs.preReleaseNumber }}
      full_semver: ${{ steps.version.outputs.fullSemVer }}
      commits_since: ${{ steps.version.outputs.commitsSinceVersionSource }}
      supported_versions: ${{ steps.versions.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Read Supported Versions
        id: versions
        run: |
          # Generate explicit (loader, version-group) matrix from per-loader JSON
          MATRIX=$(jq -c '[
            (.fabric | keys[] | {minecraft: ., loader: "fabric"}),
            (.neoforge | keys[] | {minecraft: ., loader: "neoforge"})
          ]' supportedVersions.json)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

      - name: Calculate Version
        id: version
        uses: zannagh/versionizer/calculate-version@v1

      - name: Debug Version Info
        run: |
          echo "MajorMinorPatch: ${{ steps.version.outputs.majorMinorPatch }}"
          echo "PreReleaseNumber: ${{ steps.version.outputs.preReleaseNumber }}"
          echo "FullSemVer: ${{ steps.version.outputs.fullSemVer }}"
          echo "CommitsSinceVersionSource: ${{ steps.version.outputs.commitsSinceVersionSource }}"
          echo "PreReleaseLabel: ${{ steps.version.outputs.preReleaseLabel }}"
          echo "Config Source: ${{ steps.version.outputs.configSource }}"

      - name: Check Release
        id: release-check
        uses: zannagh/versionizer/check-release@v1
        with:
          event-name: ${{ github.event_name }}
          is-dry-run: ${{ inputs.dry_run }}
          force-release: ${{ inputs.force_release }}

  validate-version:
    name: Validate Release Version
    runs-on: ubuntu-latest
    needs: analyze
    if: needs.analyze.outputs.is_manual_release == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          echo "Tag version: $VERSION"

          # Exclude pre-release tags (containing '-') so that e.g. 0.7.8 is not
          # considered a downgrade from 0.7.8-pre.2 (sort -V is not SemVer-aware).
          LATEST=$(git tag -l 'v*' --sort=-v:refname | grep -v -- '-' | head -n1 | sed 's/^v//' || echo "0.0.0")
          if [[ "$LATEST" == "$VERSION" ]]; then
            LATEST=$(git tag -l 'v*' --sort=-v:refname | grep -v -- '-' | sed -n '2p' | sed 's/^v//' || echo "0.0.0")
          fi
          echo "Latest existing version: $LATEST"

          HIGHER=$(echo -e "$VERSION\n$LATEST" | sort -V | tail -n1)
          if [[ "$HIGHER" != "$VERSION" && "$VERSION" != "$LATEST" ]]; then
            echo "::error::Version downgrade detected! New version ($VERSION) is lower than existing version ($LATEST)"
            exit 1
          fi
          echo "Version validation passed: $VERSION >= $LATEST"

  check-modrinth:
    name: Check Modrinth Versions
    runs-on: ubuntu-latest
    needs: analyze
    if: needs.analyze.outputs.should_release == 'true'
    outputs:
      version_exists: ${{ steps.modrinth-check.outputs.version_exists }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Determine version to check
        id: mod-ver
        uses: zannagh/versionizer/determine-version@v1
        with:
          is-manual-release: ${{ needs.analyze.outputs.is_manual_release }}
          release-tag-name: ${{ github.event.release.tag_name }}
          release-prerelease: ${{ github.event.release.prerelease }}
          semver: ${{ needs.analyze.outputs.semver }}
          prerelease-number: ${{ needs.analyze.outputs.prerelease_number }}
          commits-since: ${{ needs.analyze.outputs.commits_since }}

      - name: Check Modrinth Version
        id: modrinth-check
        uses: ./.github/actions/check-modrinth-version
        with:
          project-id: ${{ env.MODRINTH_PROJECT_ID }}
          mod-version: ${{ steps.mod-ver.outputs.version }}

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [analyze, check-modrinth]
    if: "!cancelled() && needs.analyze.result == 'success'"
    outputs:
      mod_version: ${{ steps.mod-ver.outputs.version }}
      is_prerelease: ${{ steps.mod-ver.outputs.is_prerelease }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Gradle Environment
        uses: zannagh/versionizer/setup-gradle-env@v1

      - name: Determine Mod Version
        id: mod-ver
        uses: zannagh/versionizer/determine-version@v1
        with:
          is-manual-release: ${{ needs.analyze.outputs.is_manual_release }}
          release-tag-name: ${{ github.event.release.tag_name }}
          release-prerelease: ${{ github.event.release.prerelease }}
          semver: ${{ needs.analyze.outputs.semver }}
          prerelease-number: ${{ needs.analyze.outputs.prerelease_number }}
          commits-since: ${{ needs.analyze.outputs.commits_since }}

      - name: Build & Stage Artifacts
        run: |
          ./gradlew stageArtifacts \
            -PsemVer="${{ steps.mod-ver.outputs.version }}" \
            -Pprerelease="${{ steps.mod-ver.outputs.is_prerelease }}"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: armor-hider-${{ steps.mod-ver.outputs.version }}
          path: staging/*.jar
          if-no-files-found: error

  changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: [analyze, build]
    if: needs.analyze.outputs.should_release == 'true'
    outputs:
      full: ${{ steps.full-changelog.outputs.content }}
      user-facing: ${{ steps.user-changelog.outputs.content }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate Full Changelog
        id: full-changelog
        uses: zannagh/versionizer/generate-changelog@v1
        with:
          is-manual-release: ${{ needs.analyze.outputs.is_manual_release }}
          release-body: ${{ github.event.release.body }}
          mod-version: ${{ needs.build.outputs.mod_version }}
          repository: ${{ github.repository }}

      - name: Generate User-Facing Changelog
        id: user-changelog
        uses: ./.github/actions/generate-user-changelog
        with:
          is-manual-release: ${{ needs.analyze.outputs.is_manual_release }}
          release-body: ${{ github.event.release.body }}
          mod-version: ${{ needs.build.outputs.mod_version }}
          repository: ${{ github.repository }}

  # ============================================================================
  # CREATE GITHUB PRERELEASE (automatic)
  # ============================================================================
  create-prerelease:
    name: Create GitHub Prerelease
    runs-on: ubuntu-latest
    needs: [analyze, check-modrinth, build, changelog]
    if: |
      needs.analyze.outputs.should_release == 'true' &&
      needs.analyze.outputs.is_manual_release != 'true' &&
      needs.check-modrinth.outputs.version_exists != 'true'
    permissions:
      contents: write
    steps:
      - name: Create Prerelease
        uses: zannagh/versionizer/create-prerelease@v1
        with:
          version: ${{ needs.build.outputs.mod_version }}
          changelog: ${{ needs.changelog.outputs.full }}
          artifact-name: armor-hider-${{ needs.build.outputs.mod_version }}
          artifact-pattern: artifacts/**/*.jar
          dry-run: ${{ inputs.dry_run }}

  # ============================================================================
  # UPLOAD TO GITHUB RELEASE (manual releases)
  # ============================================================================
  upload-to-release:
    name: Upload to GitHub Release
    runs-on: ubuntu-latest
    needs: [analyze, build, validate-version]
    if: needs.analyze.outputs.is_manual_release == 'true'
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Upload to Release
        uses: softprops/action-gh-release@v2.4.2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: artifacts/**/*.jar

  # ============================================================================
  # PUBLISH TO MODRINTH
  # ============================================================================
  publish-modrinth:
    name: Publish to Modrinth
    runs-on: ubuntu-latest
    needs: [analyze, check-modrinth, build, changelog]
    if: |
      needs.analyze.outputs.should_release == 'true' &&
      needs.analyze.outputs.is_manual_release == 'true' &&
      needs.check-modrinth.outputs.version_exists != 'true'
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.analyze.outputs.supported_versions) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Get game versions
        id: game-versions
        run: |
          # Get all compatible game versions for this loader/group from the per-loader JSON
          VERSIONS=$(jq -r '."${{ matrix.loader }}"."${{ matrix.minecraft }}" // ["${{ matrix.minecraft }}"] | .[]' supportedVersions.json)
          echo "list<<EOF" >> $GITHUB_OUTPUT
          echo "$VERSIONS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download Artifacts
        uses: actions/download-artifact@v7
        with:
          name: armor-hider-${{ needs.build.outputs.mod_version }}
          path: artifacts

      - name: Prepare Modrinth Upload
        id: modrinth
        uses: ./.github/actions/prepare-modrinth-upload
        with:
          display-version: ${{ matrix.minecraft }}
          mod-version: ${{ needs.build.outputs.mod_version }}
          is-prerelease: ${{ needs.build.outputs.is_prerelease }}
          artifact-path: artifacts
          loader: ${{ matrix.loader }}

      - name: Preview Modrinth Upload
        if: steps.modrinth.outputs.found == 'true'
        run: |
          echo "=========================================="
          echo "MODRINTH UPLOAD PREVIEW"
          echo "=========================================="
          echo ""
          echo "File: ${{ steps.modrinth.outputs.jar_path }}"
          echo ""
          echo "Version Details:"
          echo "  Project ID:    ${{ env.MODRINTH_PROJECT_ID }}"
          echo "  Version:       ${{ steps.modrinth.outputs.version_number }}"
          echo "  Display Name:  ${{ steps.modrinth.outputs.version_name }}"
          echo "  Version Type:  ${{ steps.modrinth.outputs.version_type }}"
          echo "  Game Versions: ${{ matrix.minecraft }}"
          echo "  Loader:        ${{ matrix.loader }}"
          echo ""
          echo "Changelog:"
          echo "---"
          echo "${{ needs.changelog.outputs.user-facing }}"
          echo "---"
          echo ""
          if [[ "${{ inputs.dry_run }}" != "false" ]]; then
            echo "DRY RUN - Skipping actual Modrinth upload"
          elif [[ "${{ env.PUBLISH_TO_MODRINTH }}" == "true" ]]; then
            echo "PUBLISH_TO_MODRINTH=true - Will publish to Modrinth"
          else
            echo "PUBLISH_TO_MODRINTH=false - Publishing disabled"
          fi
          echo "=========================================="

      - name: Publish to Modrinth
        if: ${{ steps.modrinth.outputs.found == 'true' && env.PUBLISH_TO_MODRINTH == 'true' && !inputs.dry_run }}
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ env.MODRINTH_PROJECT_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          files: ${{ steps.modrinth.outputs.jar_path }}
          name: ${{ steps.modrinth.outputs.version_name }}
          version: ${{ steps.modrinth.outputs.version_number }}
          version-type: ${{ steps.modrinth.outputs.version_type }}
          loaders: ${{ matrix.loader }}
          game-versions: |
            ${{ steps.game-versions.outputs.list }}
          game-version-filter: any
          changelog: ${{ needs.changelog.outputs.user-facing }}
          modrinth-featured: false
          retry-attempts: 2
          retry-delay: 10000

  # ============================================================================
  # SUMMARY
  # ============================================================================
  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [analyze, validate-version, check-modrinth, build, changelog, create-prerelease, upload-to-release, publish-modrinth]
    if: always()
    steps:
      - name: Checkout
        if: inputs.dry_run == true
        uses: actions/checkout@v6

      - name: Generate Summary
        uses: zannagh/versionizer/workflow-summary@v1
        with:
          version: ${{ needs.build.outputs.mod_version }}
          is-prerelease: ${{ needs.build.outputs.is_prerelease }}
          semver: ${{ needs.analyze.outputs.semver }}
          full-semver: ${{ needs.analyze.outputs.full_semver }}
          prerelease-number: ${{ needs.analyze.outputs.prerelease_number }}
          commits-since: ${{ needs.analyze.outputs.commits_since }}
          should-release: ${{ needs.analyze.outputs.should_release }}
          is-manual-release: ${{ needs.analyze.outputs.is_manual_release }}
          skip-reason: ${{ needs.analyze.outputs.skip_reason }}
          changelog: ${{ needs.changelog.outputs.full }}
          job-results: |
            Analyze Changes=${{ needs.analyze.result }}
            Validate Version=${{ needs.validate-version.result }}
            Check Modrinth=${{ needs.check-modrinth.result }}
            Build=${{ needs.build.result }}
            Changelog=${{ needs.changelog.result }}
            Create Prerelease=${{ needs.create-prerelease.result }}
            Upload to Release=${{ needs.upload-to-release.result }}
            Publish to Modrinth=${{ needs.publish-modrinth.result }}
          additional-sections: |
            ### Modrinth

            - **Version Already Exists**: `${{ needs.check-modrinth.outputs.version_exists }}`
            - **Publish Enabled**: `${{ env.PUBLISH_TO_MODRINTH }}`

      - name: Modrinth Upload Preview
        if: inputs.dry_run == true && needs.build.result == 'success'
        run: |
          MOD_VERSION="${{ needs.build.outputs.mod_version }}"
          IS_PRERELEASE="${{ needs.build.outputs.is_prerelease }}"
          VERSION_TYPE="release"
          if [[ "$IS_PRERELEASE" == "true" ]]; then VERSION_TYPE="beta"; fi

          TOTAL=0
          {
            echo "## Modrinth Upload Preview (Dry Run)"
            echo ""
            echo "The following versions **would** be published to Modrinth:"
            echo ""
            echo "| Loader | Version Group | Game Versions | Modrinth Version Name | Type |"
            echo "| ------ | ------------- | ------------- | --------------------- | ---- |"

            for LOADER in fabric neoforge; do
              for GROUP in $(jq -r ".${LOADER} | keys[]" supportedVersions.json); do
                GAME_VERSIONS=$(jq -r ".${LOADER}.\"${GROUP}\" // [\"${GROUP}\"] | join(\", \")" supportedVersions.json)
                DISPLAY_LOADER="${LOADER^}"
                echo "| ${DISPLAY_LOADER} | ${GROUP} | ${GAME_VERSIONS} | [${DISPLAY_LOADER}] ${GROUP} - ${MOD_VERSION} | ${VERSION_TYPE} |"
                TOTAL=$((TOTAL + 1))
              done
            done

            echo ""
            echo "**Total uploads: $TOTAL**"
          } >> "$GITHUB_STEP_SUMMARY"
